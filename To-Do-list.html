<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Engineering To-Do List </title>
    <!-- Load Tailwind CSS for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .task-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .task-completed {
            text-decoration: line-through;
            color: #9ca3af; /* Gray text for completed tasks */
            background-color: #e5e7eb;
        }
        .task-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .text-error {
            color: #dc2626; /* Red for errors */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-8">

        <!-- Header -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">To-Do list app</h1>
            <p class="text-lg text-gray-600 mt-1">Real-time Task Manager </p>
        </header>

        <!-- Input Form -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <input type="text" id="taskInput" placeholder="Add a new task (e.g., 'Study DSA')"
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <button id="addTaskBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out">
                Add Task
            </button>
        </div>
        
        <!-- Status Message Area -->
        <div id="statusMessage" class="text-sm text-center mb-4 min-h-[20px]"></div>

        <!-- To-Do List Container -->
        <div id="taskList" class="space-y-3">
            <!-- Tasks will be dynamically inserted here -->
            <p class="text-center text-gray-500" id="loadingIndicator">Loading tasks...</p>
        </div>

        <!-- Footer / User ID Display (MANDATORY for multi-user apps) -->
        <footer class="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-500 text-center">
            <p>Your unique identifier (Required for Firestore access):</p>
            <p id="userIdDisplay" class="font-mono text-xs text-gray-700 mt-1 break-all">Authenticating...</p>
            <p class="mt-2">Data is stored publicly under this application's ID in Firestore.</p>
        </footer>
    </div>

    <!-- JavaScript and Firebase Logic -->
    <script type="module">
        // --- 1. FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug for visibility
        setLogLevel('Debug');

        // --- 2. GLOBAL VARIABLES & INITIALIZATION ---
        let db;
        let auth;
        let userId = null;
        const tasksCollectionName = 'todos'; // The name of your collection
        
        // Retrieve and parse mandatory global configuration variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Fix for "projectId not provided" and "api-key-not-valid" errors when running locally ---
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                // Fallback: Provide a valid structure with a fake project ID 
                // We use a mock API key to signal "MOCK MODE" in the initialization function.
                firebaseConfig = {
                    apiKey: "mock-api-key", 
                    authDomain: "mock-project.firebaseapp.com",
                    projectId: "mock-project-id", 
                    storageBucket: "mock-project.appspot.com",
                    messagingSenderId: "0000000000",
                    appId: "1:0000000000:web:mockid"
                };
                console.warn("WARN: Using mock Firebase config. Data will only persist when run in the Canvas environment.");
            }
        } catch (e) {
            console.error("Error parsing __firebase_config. Using mock config.", e);
            // Ensure config is still available even if parsing fails
            firebaseConfig = { apiKey: "mock-api-key" };
        }
        // --- End of Fix ---

        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- 3. FIREBASE PATHS ---
        // PUBLIC Path: /artifacts/{appId}/public/data/todos
        function getCollectionRef() {
            // We are storing public data accessible to anyone using this app
            return collection(db, `artifacts/${appId}/public/data/${tasksCollectionName}`);
        }

        // --- 4. CORE FUNCTIONS ---

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // Check for mock key and enable local-only UI mode if detected
                if (firebaseConfig.apiKey === "mock-api-key") {
                    console.warn("MOCK MODE: Skipping Firebase Auth/Firestore calls to prevent API key errors during local testing.");
                    userId = 'MOCK_USER_ID_FOR_LOCAL_TESTING';
                    userIdDisplay.textContent = userId;
                    // Manually clear loading indicator and show success message
                    taskList.innerHTML = '<p class="text-center text-gray-500 py-4">UI Loaded Successfully (Mock Mode). Deploy to GitHub Pages for real functionality.</p>';
                    statusMessage.textContent = 'Local UI test successful. Real-time data is disabled.';
                    return; // Exit, skipping all real database connections
                }
                
                // Initialize Firebase App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Handle Authentication: Use custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up listener for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Authentication is complete, start listening for tasks
                        startRealTimeListener(); 
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Authentication Failed / Anonymous User';
                        taskList.innerHTML = '<p class="text-error text-center">Cannot load tasks: User not authenticated.</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                statusMessage.textContent = `Error initializing app: ${error.message}`;
                userIdDisplay.textContent = 'Initialization Failed';
            }
        }

        /**
         * Renders the list of tasks from the database.
         * @param {Array} tasks - Array of task objects from Firestore.
         */
        function renderTasks(tasks) {
            taskList.innerHTML = '';
            loadingIndicator.style.display = 'none';

            if (tasks.length === 0) {
                taskList.innerHTML = '<p class="text-center text-gray-500 py-4">You have no tasks! Add one above.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                // Use data attributes to store Firestore ID and completion status
                taskElement.dataset.id = task.id;
                taskElement.dataset.completed = task.completed;
                
                // Base classes for task item
                let classes = "task-item flex items-center justify-between p-3 rounded-lg bg-gray-50 shadow-sm";
                
                // Add completion styles if the task is done
                if (task.completed) {
                    classes += " task-completed";
                }

                taskElement.className = classes;
                
                // Structure: [Task Text] [Delete Button]
                taskElement.innerHTML = `
                    <span class="flex-grow text-base md:text-lg">${task.text}</span>
                    <button data-action="delete"
                            class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition duration-150">
                        <!-- Icon for Delete -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 10a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;

                taskList.appendChild(taskElement);

                // Add click listener for toggling completion and deleting
                taskElement.addEventListener('click', handleTaskClick);
            });
        }
        
        /**
         * Starts the real-time listener for task changes in Firestore.
         */
        function startRealTimeListener() {
            if (!db) {
                statusMessage.textContent = 'Database not initialized.';
                return;
            }

            const q = query(getCollectionRef());
            
            // onSnapshot sets up a real-time listener
            onSnapshot(q, (snapshot) => {
                const tasks = [];
                snapshot.forEach(doc => {
                    tasks.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort tasks: incomplete first, then completed
                tasks.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
                
                renderTasks(tasks);
                statusMessage.textContent = 'Tasks updated in real-time.';
            }, (error) => {
                console.error("Firestore Snapshot Error:", error);
                statusMessage.textContent = `Failed to listen for tasks: ${error.message}`;
            });
        }

        /**
         * Adds a new task to Firestore.
         */
        async function addTask(text) {
            // Check for mock mode and prevent data operations
            if (firebaseConfig.apiKey === "mock-api-key") {
                statusMessage.textContent = "Error: Cannot add tasks in local MOCK MODE. Deploy the app to enable real-time features.";
                return;
            }

            if (!db || !userId) return;

            try {
                const newTask = {
                    text: text.trim(),
                    completed: false,
                    createdAt: Date.now(),
                    // Optional: You can store the creator's ID for private apps
                    // creatorId: userId 
                };

                await addDoc(getCollectionRef(), newTask);
                statusMessage.textContent = 'Task added successfully.';
                taskInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error adding document:", error);
                statusMessage.textContent = `Error adding task: ${error.message}`;
            }
        }
        
        /**
         * Toggles the 'completed' status of a task in Firestore.
         */
        async function toggleTaskStatus(taskId, isCompleted) {
            // Check for mock mode and prevent data operations
            if (firebaseConfig.apiKey === "mock-api-key") {
                statusMessage.textContent = "Error: Cannot modify tasks in local MOCK MODE. Deploy the app to enable real-time features.";
                return;
            }

            if (!db) return;
            
            try {
                const taskDocRef = doc(getCollectionRef(), taskId);
                await updateDoc(taskDocRef, {
                    completed: !isCompleted
                });
                statusMessage.textContent = `Task ${!isCompleted ? 'completed' : 'reopened'}!`;
            } catch (error) {
                console.error("Error updating document:", error);
                statusMessage.textContent = `Error toggling task: ${error.message}`;
            }
        }
        
        /**
         * Deletes a task from Firestore.
         */
        async function deleteTask(taskId) {
            // Check for mock mode and prevent data operations
            if (firebaseConfig.apiKey === "mock-api-key") {
                statusMessage.textContent = "Error: Cannot delete tasks in local MOCK MODE. Deploy the app to enable real-time features.";
                return;
            }

            if (!db) return;
            
            try {
                const taskDocRef = doc(getCollectionRef(), taskId);
                await deleteDoc(taskDocRef);
                statusMessage.textContent = 'Task deleted.';
            } catch (error) {
                console.error("Error deleting document:", error);
                statusMessage.textContent = `Error deleting task: ${error.message}`;
            }
        }

        // --- 5. EVENT HANDLERS ---
        
        // Handle adding a task via button click
        addTaskBtn.addEventListener('click', () => {
            const text = taskInput.value;
            if (text.trim() === "") {
                statusMessage.textContent = "Task description cannot be empty.";
                return;
            }
            addTask(text);
        });

        // Handle adding a task via Enter key press
        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTaskBtn.click();
            }
        });
        
        // Handle clicks on individual tasks (toggle complete or delete)
        function handleTaskClick(event) {
            const taskElement = event.currentTarget;
            const taskId = taskElement.dataset.id;
            const isCompleted = taskElement.dataset.completed === 'true';
            
            // Check if the delete button was clicked
            if (event.target.closest('[data-action="delete"]')) {
                // Use a modal-like confirmation instead of alert()
                showCustomConfirmation(taskId);
            } else {
                // If the main task body was clicked, toggle status
                toggleTaskStatus(taskId, isCompleted);
            }
        }
        
        // Custom confirmation dialog replacement for alert()/confirm()
        function showCustomConfirmation(taskId) {
            const existingModal = document.getElementById('customModal');
            if(existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h5 class="text-xl font-semibold mb-3 text-gray-800">Confirm Deletion</h5>
                    <p class="mb-4 text-gray-600">Are you sure you want to delete this task? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDeleteBtn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                        <button id="confirmDeleteBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                modal.remove();
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                deleteTask(taskId);
                modal.remove();
            });
        }
        
        // --- 6. START APPLICATION ---
        initializeFirebaseAndAuth();
        
    </script>
</body>
</html>